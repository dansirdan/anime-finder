<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Anime Finder</title>
  <!-- <link rel="stylesheet" href="../css/style.css"> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
    integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://code.jquery.com/jquery.js"></script>
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>
</head>

<body>

  <!-- NAV -->
  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="/home">Anime Finder</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText"
      aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/home">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/survey">Questionnaire</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- CONTENT -->
  <div class="container">
    <br><br>
    <form>
      <div class="form-row">
        <div class="col-md-4 mb-3">
          <label for="user_name">Username:</label>
          <input type="text" class="form-control" id="user_name" placeholder="otaku_123" required>
          <div class="valid-feedback">
            Looks good!
          </div>
        </div>
        <!-- I COULD PAIR USERS TOGETHER IF THEIR GENRE MATCHES -->
        <!-- MAYBE PHASE II. -->
        <!-- SERVE THEM THE PAIRE GENRE AND AN IMAGE OF THE PEOPLE WHO ALSO GOT PAIRED WITH GENRE -->
        <div class="col-md-8 mb-3">
          <label for="pic_url">Avatar URL:</label>
          <input type="text" class="form-control" id="avatar_link"
            placeholder="https://avatarfiles.alphacoders.com/177/177170.jpg" required>
          <div class="valid-feedback">
            Looks good!
          </div>
        </div>
      </div>
      <br>
      <!-- Question 1 -->
      <select class="custom-select" id="q1">
        <option selected>How much anime have you watched previously?</option>
        <option value="1">1 (little to none)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (quite a bit)</option>
      </select>
      <br><br>
      <!-- Question 2 -->
      <select class="custom-select" id="q2">
        <option selected>How open are you to new ideas?</option>
        <option value="1">1 (not at all)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (whatcha got?)</option>
      </select>
      <br><br>
      <!-- Question 3 -->
      <select class="custom-select" id="q3">
        <option selected>Do you enjoy conflict?</option>
        <option value="1">1 (I don't)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (I live for conflict)</option>
      </select>
      <br><br>
      <!-- Question 4 -->
      <select class="custom-select" id="q4">
        <option selected>How likely are you to react to a cute doggo?</option>
        <option value="1">1 (not likely)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (KAWAII! I LOVE CUTE DOGGOS SO MUCH!)</option>
      </select>
      <br><br>
      <!-- Question 5 -->
      <select class="custom-select" id="q5">
        <option selected>Do violent shows inspire violence?</option>
        <option value="1">1 (disagree)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (agree)</option>
      </select>
      <br><br>
      <!-- Question 6 -->
      <select class="custom-select" id="q6">
        <option selected>How engaged are you when watching a show?</option>
        <option value="1">1 (not at all, its background noise)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (there is no talking or doing, just watching)</option>
      </select>
      <br><br>
      <!-- Question 7 -->
      <select class="custom-select" id="q7">
        <option selected>Are you easily affected by other's emotions?</option>
        <option value="1">1 (what are emotions?)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (EMOTIONAL WRECK)</option>
      </select>
      <br><br>
      <!-- Question 8 -->
      <select class="custom-select" id="q8">
        <option selected>How much are you willing to think during a show?</option>
        <option value="1">1 (not at all)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (give me cerebral stimulation or give me death)</option>
      </select>
      <br><br>
      <!-- Question 9 -->
      <select class="custom-select" id="q9">
        <option selected>Are you interested in sports?</option>
        <option value="1">1 (not at all)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (very much so)</option>
      </select>
      <br><br>
      <!-- Question 10 -->
      <select class="custom-select" id="q10">
        <option selected>Science & Technology: how accurate should this be in a show?</option>
        <option value="1">1 (why get caught up on the details?)</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5 (very accurate)</option>
      </select>
      <br><br>
      <button type="submit" class="btn btn-primary" id="submit_Q">Submit</button>

    </form>

  </div>

  <div class="modal fade" id="anime_modal" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="match_found">
            <!-- ANIME GENRE PUSHED HERE -->
          </h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <a href="" id="myAnimeList_link">

            <!-- LINK TO ANIME GENRE PUSHED HERE -->
          </a>
          <div class="embed-responsive embed-responsive-16by9">
            <iframe id="modalVideo" class="embed-responsive-item" src="" frameborder='0' allowfullscreen>
              <!-- VIDEO PUSHED HERE use jQuery to change src -->
            </iframe>
          </div>
          <p id="description">
            <!-- DESCRIPTION PUSHED HERE -->
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="close_it">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function () {

      let score_arr = [];
      let avatar_link = "";
      let url = $("#modalVideo").attr('src');

      $("#submit_Q").on("click", function (e) {
        e.preventDefault();

        for (let i = 1; i < 11; i++) {
          let score = $(`#q${i}`)[0].value;
          let int_score = parseInt(score);
          score_arr.push(int_score);
        };

        let newUser = {
          name: $("#user_name").val().trim(),
          avatar: $("#avatar_link").val().trim(),
          scores: score_arr
        };
        // console.log(newUser)
        // $.post("")
        // pop up modale
        $.post("/api/users", newUser, function () {
          $("#avatar_link").val("");
          $("#user_name").val("");
        });


        $.get("/api/users", function (data) {
          console.log(data);
          // for (let i = 0; i < data.length; i++) {
          //   let user_name = data[i].name;
          //   let user_avatar = data[i].avatar;
          //   let user_scores = data[i].scores;
          //   for (let i = 0; i < user_scores.length; i++) {
          //     // compare score_arr with all the arrays
          //     // return a match
          //   };
          // };
        });

        // an array of objects to hold the matches with all the info,
        // INCLUDING the total match score. (to be interated over after)...
        let pre_match_array = [];

        $.get("/api/genres", function (data) {
          console.log(data);
          for (let i = 0; i < data.length; i++) {

            let genre_name = data[i].genre;
            let example_vid = data[i].video;
            let genre_link = data[i].link;
            let genre_desc = data[i].description;
            let genre_scores = data[i].scores;

            let this_diff_arr = [];

            for (let i = 0; i < genre_scores.length; i++) {

              // compare score_arr with all the arrays
              // return a match
              let diff = Math.abs(score_arr[i] - genre_scores[i]);
              this_diff_arr.push(diff);
              console.log(diff);

            };

            // KEY PART THAT USES THE REDUCE METHOD TO GET THE TOTAL DIFFERENCE
            // need to create an object now that pulls in on the above if and returns
            // the lowest number...if more than one category exists alert them but only
            // show the first match...maybe pull in all the matches as a link?

            let calc_diff = this_diff_arr.reduce((a, b) => a + b, 0);
            let pre_match = {
              genre: genre_name,
              video: example_vid,
              link: genre_link,
              description: genre_desc,
              difference_score: calc_diff
            }

            pre_match_array.push(pre_match);
            // console.log(this_diff_arr);
          };
          console.log(pre_match_array);

          let lowest = Number.POSITIVE_INFINITY;
          let tmp;
          for (let i = pre_match_array.length - 1; i >= 0; i--) {
            tmp = pre_match_array[i].difference_score;
            if (tmp < lowest) {
              lowest = tmp;
            };
          };

          console.log(lowest);

          for (let i = 0; i < pre_match_array.length; i++) {
            let check = pre_match_array[i].difference_score;
            if (check === lowest) {
              url = pre_match_array[i].video
              $("#modalVideo").attr('src', url);
              $("#match_found").html(pre_match_array[i].genre);
              $("#description").html(pre_match_array[i].description);
              $("myAnimeList_link").attr('href', pre_match_array[i].link)
              $("#anime_modal").modal('show');
              return;
            };
          };
        });
      });

      $("#close_it").on("click", function (e) {
        $("#anime_modal").modal('hide');
      })

      $("#anime_modal").on('hide.bs.modal', function () {
        $("#modalVideo").attr('src', '');
      });

      $("#anime_modal").on('show.bs.modal', function () {
        $("#modalVideo").attr('src', url);
      });

    });
  </script>

</body>

</html>